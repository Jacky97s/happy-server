version: '3.8'
services:
    happy-server:
        build: .
        restart: unless-stopped
        environment:
            - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/happy-server
            - REDIS_URL=redis://redis:6379
            - PORT=3005
            - S3_HOST=minio
            - S3_PORT=9000
            - S3_USE_SSL=false
            - S3_ACCESS_KEY=${S3_ACCESS_KEY:-minioadmin}
            - S3_SECRET_KEY=${S3_SECRET_KEY:-minioadmin}
            - S3_BUCKET=happy
            - S3_PUBLIC_URL=${S3_PUBLIC_URL:-http://localhost:9000/happy}
            - HANDY_MASTER_SECRET=${HANDY_MASTER_SECRET}
        ports:
            - "127.0.0.1:3005:3005"
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            minio:
                condition: service_started
        command: sh -c "npx prisma migrate deploy --schema /app/prisma/schema.prisma && yarn start"
        healthcheck:
            test: ["CMD-SHELL", "wget -q -O - http://localhost:3005/health || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 3

    postgres:
        image: postgres:15
        restart: unless-stopped
        environment:
            - POSTGRES_DB=happy-server
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=postgres
            - TZ=Asia/Shanghai
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres -d happy-server -h localhost"]
            interval: 30s
            timeout: 10s
            retries: 10

    redis:
        image: redis:7.2-alpine
        restart: unless-stopped
        volumes:
            - redis_data:/data
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 30s
            timeout: 3s
            retries: 5

    minio:
        image: minio/minio:latest
        command: server /data --console-address ":9001"
        restart: unless-stopped
        environment:
            MINIO_ROOT_USER: ${S3_ACCESS_KEY:-minioadmin}
            MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-minioadmin}
        ports:
            - "127.0.0.1:9000:9000"
            - "127.0.0.1:9001:9001"
        volumes:
            - minio_data:/data

    minio-init:
        image: minio/mc:latest
        depends_on:
            minio:
                condition: service_started
        environment:
            MINIO_ROOT_USER: ${S3_ACCESS_KEY:-minioadmin}
            MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-minioadmin}
            S3_BUCKET: ${S3_BUCKET:-happy}
        entrypoint: /bin/sh
        command:
            - -c
            - |
                echo "[minio-init] Setting up alias..."
                mc alias set local http://minio:9000 "$$MINIO_ROOT_USER" "$$MINIO_ROOT_PASSWORD"
                echo "[minio-init] Waiting for MinIO..."
                until mc ready --json local >/dev/null 2>&1; do echo "[minio-init] Still waiting..."; sleep 2; done
                echo "[minio-init] Creating bucket $$S3_BUCKET..."
                mc mb -p local/$$S3_BUCKET || true
                echo "[minio-init] Setting anonymous download..."
                mc anonymous set download local/$$S3_BUCKET || true
                echo "[minio-init] Done!"
        restart: "no"

volumes:
    postgres_data:
    redis_data:
    minio_data:
